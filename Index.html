<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fanfiction Library</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
    }

    .app-container {
        max-width: 100vw;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        min-height: 100vh;
    }

    .app-header {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        padding: 1rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .app-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
    }

    .nav-tabs {
        display: flex;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
    }

    .nav-tab {
        flex: 1;
        min-width: 120px;
        padding: 1rem;
        text-align: center;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
    }

    .nav-tab.active {
        color: #4f46e5;
        border-bottom-color: #4f46e5;
        background: rgba(79, 70, 229, 0.05);
    }

    .nav-tab i {
        display: block;
        font-size: 1.2rem;
        margin-bottom: 0.25rem;
    }

    .content-area {
        padding: 1rem;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .form-section {
        background: white;
        margin-bottom: 1rem;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .form-section h3 {
        color: #4f46e5;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        min-height: 48px;
    }

    .btn-primary {
        background: #4f46e5;
        color: white;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-full {
        width: 100%;
        justify-content: center;
    }

    .story-grid {
        display: grid;
        gap: 1rem;
    }

    .story-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-left: 4px solid #4f46e5;
        cursor: pointer;
        display: flex;
        gap: 1rem;
    }

    .story-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .story-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .story-author {
        color: #6b7280;
        margin-bottom: 0.5rem;
    }

    .meta-tag {
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        color: #374151;
        display: inline-block;
        margin: 0.25rem 0.25rem 0 0;
    }

    .category-tag {
        background: #4f46e5;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        display: inline-block;
        margin: 0.25rem 0.25rem 0 0;
    }

    .checkbox-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .checkbox-item input {
        width: auto;
        margin: 0;
    }

    .radio-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .message {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }

    .message.success {
        background: #d1fae5;
        color: #065f46;
    }

    .message.error {
        background: #fee2e2;
        color: #991b1b;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        padding: 1rem;
        overflow-y: auto;
    }

    .modal.active {
        display: flex;
        align-items: start;
        justify-content: center;
        padding-top: 2rem;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        max-width: 90vw;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
    }
</style>
```

</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fas fa-book-open"></i> Fanfiction Library</h1>
        </header>

```
    <nav class="nav-tabs">
        <button class="nav-tab active" id="tab-library">
            <i class="fas fa-books"></i>
            Library
        </button>
        <button class="nav-tab" id="tab-add">
            <i class="fas fa-plus"></i>
            Add Story
        </button>
        <button class="nav-tab" id="tab-analytics">
            <i class="fas fa-chart-bar"></i>
            Analytics
        </button>
    </nav>

    <div class="content-area">
        <div id="content-library" class="tab-content active">
            <div class="form-section">
                <input type="text" id="search-input" placeholder="Search stories..." style="margin-bottom: 0.5rem;">
                <select id="category-filter">
                    <option value="">All Categories</option>
                    <option value="tbr">TBR</option>
                    <option value="completed">Completed</option>
                    <option value="dnf">DNF</option>
                    <option value="reread">Re-read</option>
                </select>
            </div>
            <div id="story-grid" class="story-grid">
                <p style="text-align: center; padding: 2rem; color: #6b7280;">No stories added yet. Use the "Add Story" tab to get started!</p>
            </div>
        </div>

        <div id="content-add" class="tab-content">
            <div id="message" class="message"></div>

            <div class="form-section">
                <h3><i class="fas fa-link"></i> Quick Add from URL</h3>
                <div class="form-group">
                    <input type="url" id="story-url" placeholder="https://archiveofourown.org/works/...">
                </div>
                <button class="btn btn-primary btn-full" id="scrape-btn">Detect Platform from URL</button>
                <p style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem;">Paste a URL to auto-detect the platform, then manually fill in the story details.</p>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="title">
                </div>
                <div class="form-group">
                    <label>Author *</label>
                    <input type="text" id="author">
                </div>
                <div class="form-group">
                    <label>Platform</label>
                    <select id="platform">
                        <option value="">Select Platform</option>
                        <option value="AO3">Archive of Our Own (AO3)</option>
                        <option value="FanFiction.Net">FanFiction.Net</option>
                        <option value="Wattpad">Wattpad</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Word Count</label>
                    <input type="number" id="word-count">
                </div>
                <div class="form-group">
                    <label>Chapters</label>
                    <input type="number" id="chapters">
                </div>
                <div class="form-group">
                    <label>Rating</label>
                    <select id="rating">
                        <option value="">Select Rating</option>
                        <option value="General Audiences">General Audiences</option>
                        <option value="Teen and Up Audiences">Teen and Up Audiences</option>
                        <option value="Mature">Mature</option>
                        <option value="Explicit">Explicit</option>
                        <option value="Not Rated">Not Rated</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Relationships</label>
                    <input type="text" id="relationships" placeholder="e.g., Harry Potter/Draco Malfoy">
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-bookmark"></i> Reading Format</h3>
                <div class="radio-group">
                    <label><input type="radio" name="reading-format" value="digital" checked> Digital</label>
                    <label><input type="radio" name="reading-format" value="audio"> Audio</label>
                </div>
                <div id="audio-fields" style="display: none;">
                    <div class="form-group">
                        <label>Podcast Name</label>
                        <input type="text" id="podcast-name">
                    </div>
                    <div class="form-group">
                        <label>Podcast Length</label>
                        <input type="text" id="podcast-length" placeholder="e.g., 2h 30m">
                    </div>
                    <div class="form-group">
                        <label>Podcast URL</label>
                        <input type="url" id="podcast-url">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-image"></i> Cover Image</h3>
                <div id="cover-preview-container" style="display: none; text-align: center; margin-bottom: 1rem;">
                    <img id="cover-preview" style="max-width: 200px; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <br>
                    <button class="btn btn-danger" id="remove-cover" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div id="upload-section">
                    <input type="file" id="cover-upload" accept="image/*">
                    <p style="color: #6b7280; font-size: 0.85rem; margin-top: 0.5rem;">Upload a cover image (JPG, PNG, GIF). Max 5MB.</p>
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-align-left"></i> Summary</h3>
                <div class="form-group">
                    <textarea id="summary" rows="4" placeholder="Enter story summary..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-tags"></i> Categories</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-item"><input type="checkbox" id="cat-tbr" value="tbr" checked> TBR</label>
                    <label class="checkbox-item"><input type="checkbox" id="cat-completed" value="completed"> Completed</label>
                    <label class="checkbox-item"><input type="checkbox" id="cat-dnf" value="dnf"> DNF</label>
                    <label class="checkbox-item"><input type="checkbox" id="cat-reread" value="reread"> Re-read</label>
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-heart"></i> Tropes</h3>
                <div class="checkbox-grid" id="tropes-grid"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-magic"></i> Themes</h3>
                <div class="checkbox-grid" id="themes-grid"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-exclamation-triangle"></i> Warnings</h3>
                <div class="checkbox-grid" id="warnings-grid"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-clock"></i> Eras</h3>
                <div class="checkbox-grid" id="eras-grid"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-sticky-note"></i> Personal Notes</h3>
                <div class="form-group">
                    <textarea id="notes" rows="3" placeholder="Your personal thoughts about this story..."></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" id="clear-btn" style="flex: 1;">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <button class="btn btn-primary" id="save-btn" style="flex: 2;">
                    <i class="fas fa-save"></i> Save Story
                </button>
            </div>
        </div>

        <div id="content-analytics" class="tab-content">
            <div class="form-section">
                <h3><i class="fas fa-chart-line"></i> Library Statistics</h3>
                <button class="btn btn-primary btn-full" id="analytics-btn">
                    <i class="fas fa-refresh"></i> Generate Report
                </button>
            </div>
            <div id="stats-container"></div>
        </div>
    </div>
</div>

<div id="story-modal" class="modal">
    <div class="modal-content">
        <button class="modal-close" id="modal-close-btn">&times;</button>
        <div id="story-details"></div>
    </div>
</div>

<script>
    var TROPES = [
        'Alternative Universe (A.U.)', 'Angst', 'adversaries to lovers', 'Canon Divergence', 'chosen one',
        'creature heritage', 'enemies to lovers', 'fake dating', 'fated mates', 'fight to the death',
        'Fluff', 'forced proximity - forced bed-sharing', 'forced proximity - shared quarters', 'friends-to-lovers',
        'grumpy/sunshine', 'here comes the calvary', 'Hogwarts era', 'Humor', 'hurt/comfort', 'instalove',
        'lone wolf & cub', 'love potion fallout', 'magical maturity', 'Marauders Era', 'marriage',
        'marriage law', 'marriage of convenience', 'mistaken identity', 'next-generation', 'one bed',
        'one night stand', 'opposites attract', 'post-war relationship', 'Post-Hogwarts era', 'quest',
        'reading the books', 'redemption arc', 'reluctant hero', 'Romance', 'second chance', 'secret heir',
        'secret relationship', 'slow burn', 'Smut', 'soulmate/soul bond A.U.', 'time travel fix-it', 'trials',
        'Wartime Era', 'Dark side wins', '8th year', 'professors', 'quidditch', 'parent(s)', 'soul bonding',
        'rom-com', 'co-workers', 'memory loss', 'alpha/omega', 'time travel'
    ];

    var THEMES = [
        'Ghosts', 'vampires', 'zombies', 'werewolves', 'fae', 'witches', 'death/reaper', 'sentient environment',
        'curse', 'demigods', 'physical disability', 'mental disability', 'neurodivergence', 'chronic illness', 'mental illness'
    ];

    var WARNINGS = [
        'No Warnings Apply', 'Creator Chose Not to Use Archive Warnings', 'Graphic Depiction of Violence',
        'Major Character Death', 'Underage Sex', 'Rape/Non-Con'
    ];

    var ERAS = [
        'Alternative Universe (A.U.)', 'Canon Divergence', 'Hogwarts', 'Post-Hogwarts', 'Wartime',
        'Marauders', 'Next Generation', '35+'
    ];

    var stories = [];
    var currentCoverImage = null;
    var currentEditId = null;

    function switchTab(tabName) {
        document.querySelectorAll('.nav-tab').forEach(function(tab) {
            tab.classList.remove('active');
        });
        document.getElementById('tab-' + tabName).classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(function(content) {
            content.classList.remove('active');
        });
        document.getElementById('content-' + tabName).classList.add('active');
    }

    function showMessage(text, type) {
        var messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = 'message ' + (type || 'success');
        messageEl.style.display = 'block';
        
        setTimeout(function() {
            messageEl.style.display = 'none';
        }, 5000);
    }

    function populateCheckboxes() {
        populateCheckboxGrid('tropes-grid', TROPES);
        populateCheckboxGrid('themes-grid', THEMES);
        populateCheckboxGrid('warnings-grid', WARNINGS);
        populateCheckboxGrid('eras-grid', ERAS);
    }

    function populateCheckboxGrid(containerId, items) {
        var container = document.getElementById(containerId);
        container.innerHTML = '';
        
        items.forEach(function(item, index) {
            var label = document.createElement('label');
            label.className = 'checkbox-item';
            
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item;
            checkbox.id = containerId + '-' + index;
            
            var text = document.createTextNode(' ' + item);
            
            label.appendChild(checkbox);
            label.appendChild(text);
            container.appendChild(label);
        });
    }

    function toggleAudioFields() {
        var audioFields = document.getElementById('audio-fields');
        var isAudio = document.querySelector('input[name="reading-format"]:checked').value === 'audio';
        audioFields.style.display = isAudio ? 'block' : 'none';
    }

    function handleCoverUpload(e) {
        var file = e.target.files[0];
        if (!file) return;

        if (!file.type.match('image.*')) {
            showMessage('Please select a valid image file', 'error');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            showMessage('Image is too large. Please select an image under 5MB', 'error');
            return;
        }

        var reader = new FileReader();
        reader.onload = function(event) {
            var img = new Image();
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                
                var maxWidth = 400;
                var maxHeight = 600;
                var width = img.width;
                var height = img.height;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                currentCoverImage = {
                    data: dataUrl.split(',')[1],
                    contentType: 'image/jpeg'
                };
                
                document.getElementById('cover-preview').src = dataUrl;
                document.getElementById('cover-preview-container').style.display = 'block';
                document.getElementById('upload-section').style.display = 'none';
                showMessage('Cover image uploaded!');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    function removeCover() {
        currentCoverImage = null;
        document.getElementById('cover-preview-container').style.display = 'none';
        document.getElementById('upload-section').style.display = 'block';
        document.getElementById('cover-upload').value = '';
        showMessage('Cover removed');
    }

    function getCheckedValues(selector) {
        var values = [];
        document.querySelectorAll(selector).forEach(function(checkbox) {
            if (checkbox.checked) {
                values.push(checkbox.value);
            }
        });
        return values;
    }

    function saveStory() {
        var title = document.getElementById('title').value.trim();
        var author = document.getElementById('author').value.trim();
        
        if (!title || !author) {
            showMessage('Title and Author are required', 'error');
            return;
        }
        
        var story = {
            id: currentEditId || Date.now(),
            title: title,
            author: author,
            platform: document.getElementById('platform').value,
            url: document.getElementById('story-url').value.trim(),
            wordCount: parseInt(document.getElementById('word-count').value) || null,
            chapters: parseInt(document.getElementById('chapters').value) || null,
            rating: document.getElementById('rating').value,
            relationships: document.getElementById('relationships').value.trim(),
            summary: document.getElementById('summary').value.trim(),
            readingFormat: document.querySelector('input[name="reading-format"]:checked').value,
            podcastName: document.getElementById('podcast-name').value.trim(),
            podcastLength: document.getElementById('podcast-length').value.trim(),
            podcastUrl: document.getElementById('podcast-url').value.trim(),
            notes: document.getElementById('notes').value.trim(),
            coverImage: currentCoverImage,
            categories: getCheckedValues('#content-add input[id^="cat-"]:checked'),
            tropes: getCheckedValues('#tropes-grid input:checked'),
            themes: getCheckedValues('#themes-grid input:checked'),
            warnings: getCheckedValues('#warnings-grid input:checked'),
            eras: getCheckedValues('#eras-grid input:checked'),
            dateAdded: currentEditId ? stories.find(function(s) { return s.id === currentEditId; }).dateAdded : new Date().toISOString(),
            lastUpdated: new Date().toISOString()
        };
        
        if (currentEditId) {
            var index = stories.findIndex(function(s) { return s.id === currentEditId; });
            if (index !== -1) {
                stories[index] = story;
            }
        } else {
            stories.push(story);
        }
        
        localStorage.setItem('fanfiction_stories', JSON.stringify(stories));
        
        displayStories();
        clearForm();
        showMessage(currentEditId ? 'Story updated successfully!' : 'Story saved successfully!');
        switchTab('library');
    }

    function clearForm() {
        document.getElementById('title').value = '';
        document.getElementById('author').value = '';
        document.getElementById('platform').value = '';
        document.getElementById('story-url').value = '';
        document.getElementById('word-count').value = '';
        document.getElementById('chapters').value = '';
        document.getElementById('rating').value = '';
        document.getElementById('relationships').value = '';
        document.getElementById('summary').value = '';
        document.getElementById('podcast-name').value = '';
        document.getElementById('podcast-length').value = '';
        document.getElementById('podcast-url').value = '';
        document.getElementById('notes').value = '';
        
        document.querySelector('input[name="reading-format"][value="digital"]').checked = true;
        toggleAudioFields();
        
        document.querySelectorAll('#content-add input[type="checkbox"]').forEach(function(cb) {
            cb.checked = cb.id === 'cat-tbr';
        });
        
        removeCover();
        currentEditId = null;
    }

    function displayStories() {
        var grid = document.getElementById('story-grid');
        
        if (stories.length === 0) {
            grid.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No stories added yet. Use the "Add Story" tab to get started!</p>';
            return;
        }
        
        grid.innerHTML = stories.map(function(story) {
            var coverHtml = story.coverImage 
                ? '<div style="width: 80px; height: 120px; flex-shrink: 0;"><img src="data:' + story.coverImage.contentType + ';base64,' + story.coverImage.data + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>'
                : '<div style="width: 80px; height: 120px; flex-shrink: 0; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;"><i class="fas fa-book fa-2x"></i></div>';
            
            return '<div class="story-card" onclick="viewStory(' + story.id + ')">' +
                coverHtml +
                '<div style="flex: 1; min-width: 0;">' +
                    '<div class="story-title">' + escapeHtml(story.title) + '</div>' +
                    '<div class="story-author">by ' + escapeHtml(story.author) + '</div>' +
                    '<div>' +
                        (story.platform ? '<span class="meta-tag">' + story.platform + '</span>' : '') +
                        (story.wordCount ? '<span class="meta-tag">' + story.wordCount.toLocaleString() + ' words</span>' : '') +
                        (story.chapters ? '<span class="meta-tag">' + story.chapters + ' chapters</span>' : '') +
                        (story.rating ? '<span class="meta-tag">' + story.rating + '</span>' : '') +
                    '</div>' +
                    '<div style="margin-top: 0.5rem;">' +
                        story.categories.map(function(cat) { return '<span class="category-tag">' + cat.toUpperCase() + '</span>'; }).join('') +
                    '</div>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function filterStories() {
        var searchTerm = document.getElementById('search-input').value.toLowerCase();
        var categoryFilter = document.getElementById('category-filter').value;
        
        var filtered = stories.filter(function(story) {
            var matchesSearch = !searchTerm || 
                story.title.toLowerCase().includes(searchTerm) ||
                story.author.toLowerCase().includes(searchTerm) ||
                (story.summary && story.summary.toLowerCase().includes(searchTerm));
            
            var matchesCategory = !categoryFilter || story.categories.includes(categoryFilter);
            
            return matchesSearch && matchesCategory;
        });
        
        var grid = document.getElementById('story-grid');
        
        if (filtered.length === 0) {
            grid.innerHTML = '<p style="text-align: center; padding: 2rem; color: #6b7280;">No stories match your search.</p>';
            return;
        }
        
        grid.innerHTML = filtered.map(function(story) {
            var coverHtml = story.coverImage 
                ? '<div style="width: 80px; height: 120px; flex-shrink: 0;"><img src="data:' + story.coverImage.contentType + ';base64,' + story.coverImage.data + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></div>'
                : '<div style="width: 80px; height: 120px; flex-shrink: 0; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;"><i class="fas fa-book fa-2x"></i></div>';
            
            return '<div class="story-card" onclick="viewStory(' + story.id + ')">' +
                coverHtml +
                '<div style="flex: 1; min-width: 0;">' +
                    '<div class="story-title">' + escapeHtml(story.title) + '</div>' +
                    '<div class="story-author">by ' + escapeHtml(story.author) + '</div>' +
                    '<div>' +
                        (story.platform ? '<span class="meta-tag">' + story.platform + '</span>' : '') +
                        (story.wordCount ? '<span class="meta-tag">' + story.wordCount.toLocaleString() + ' words</span>' : '') +
                        (story.chapters ? '<span class="meta-tag">' + story.chapters + ' chapters</span>' : '') +
                        (story.rating ? '<span class="meta-tag">' + story.rating + '</span>' : '') +
                    '</div>' +
                    '<div style="margin-top: 0.5rem;">' +
                        story.categories.map(function(cat) { return '<span class="category-tag">' + cat.toUpperCase() + '</span>'; }).join('') +
                    '</div>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function viewStory(storyId) {
        var story = stories.find(function(s) { return s.id === storyId; });
        if (!story) return;
        
        var modal = document.getElementById('story-modal');
        var details = document.getElementById('story-details');
        
        var coverHtml = story.coverImage 
            ? '<div style="text-align: center; margin-bottom: 2rem;"><img src="data:' + story.coverImage.contentType + ';base64,' + story.coverImage.data + '" style="max-width: 200px; max-height: 300px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);"></div>'
            : '';
        
        details.innerHTML = coverHtml +
            '<h2 style="color: #4f46e5; margin-bottom: 0.5rem;">' + escapeHtml(story.title) + '</h2>' +
            '<p style="color: #6b7280; font-size: 1.1rem; margin-bottom: 2rem;">by ' + escapeHtml(story.author) + '</p>' +
            '<div class="form-section">' +
                '<h3><i class="fas fa-info-circle"></i> Basic Info</h3>' +
                '<p><strong>Platform:</strong> ' + (story.platform || 'Not specified') + '</p>' +
                (story.url ? '<p><strong>URL:</strong> <a href="' + story.url + '" target="_blank" style="color: #4f46e5;">' + story.url + '</a></p>' : '') +
                '<p><strong>Word Count:</strong> ' + (story.wordCount ? story.wordCount.toLocaleString() : 'Unknown') + '</p>' +
                '<p><strong>Chapters:</strong> ' + (story.chapters || 'Unknown') + '</p>' +
                '<p><strong>Rating:</strong> ' + (story.rating || 'Not rated') + '</p>' +
                '<p><strong>Reading Format:</strong> ' + (story.readingFormat === 'audio' ? 'Audio' : 'Digital') + '</p>' +
                (story.readingFormat === 'audio' && story.podcastName ? '<p><strong>Podcast:</strong> ' + story.podcastName + ' (' + story.podcastLength + ')</p>' : '') +
            '</div>' +
            (story.relationships ? '<div class="form-section"><h3><i class="fas fa-heart"></i> Relationships</h3><p>' + escapeHtml(story.relationships) + '</p></div>' : '') +
            (story.summary ? '<div class="form-section"><h3><i class="fas fa-align-left"></i> Summary</h3><p style="line-height: 1.6;">' + escapeHtml(story.summary) + '</p></div>' : '') +
            '<div class="form-section"><h3><i class="fas fa-tags"></i> Categories</h3><div>' +
                story.categories.map(function(cat) { return '<span class="category-tag">' + cat.toUpperCase() + '</span>'; }).join('') +
            '</div></div>' +
            (story.tropes.length > 0 ? '<div class="form-section"><h3><i class="fas fa-heart"></i> Tropes</h3><p>' + story.tropes.join(', ') + '</p></div>' : '') +
            (story.themes.length > 0 ? '<div class="form-section"><h3><i class="fas fa-magic"></i> Themes</h3><p>' + story.themes.join(', ') + '</p></div>' : '') +
            (story.warnings.length > 0 ? '<div class="form-section"><h3><i class="fas fa-exclamation-triangle"></i> Warnings</h3><p>' + story.warnings.join(', ') + '</p></div>' : '') +
            (story.eras.length > 0 ? '<div class="form-section"><h3><i class="fas fa-clock"></i> Eras</h3><p>' + story.eras.join(', ') + '</p></div>' : '') +
            (story.notes ? '<div class="form-section"><h3><i class="fas fa-sticky-note"></i> Personal Notes</h3><p style="line-height: 1.6;">' + escapeHtml(story.notes) + '</p></div>' : '') +
            '<div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">' +
                '<button class="btn btn-primary" onclick="editStory(' + story.id + ')" style="flex: 1;"><i class="fas fa-edit"></i> Edit</button>' +
                '<button class="btn btn-danger" onclick="deleteStory(' + story.id + ')" style="flex: 1;"><i class="fas fa-trash"></i> Delete</button>' +
            '</div>';
        
        modal.classList.add('active');
    }

    function editStory(storyId) {
        var story = stories.find(function(s) { return s.id === storyId; });
        if (!story) return;
        
        currentEditId = storyId;
        
        document.getElementById('story-url').value = story.url || '';
        document.getElementById('title').value = story.title;
        document.getElementById('author').value = story.author;
        document.getElementById('platform').value = story.platform || '';
        document.getElementById('word-count').value = story.wordCount || '';
        document.getElementById('chapters').value = story.chapters || '';
        document.getElementById('rating').value = story.rating || '';
        document.getElementById('relationships').value = story.relationships || '';
        document.getElementById('summary').value = story.summary || '';
        document.getElementById('podcast-name').value = story.podcastName || '';
        document.getElementById('podcast-length').value = story.podcastLength || '';
        document.getElementById('podcast-url').value = story.podcastUrl || '';
        document.getElementById('notes').value = story.notes || '';
        
        document.querySelector('input[name="reading-format"][value="' + story.readingFormat + '"]').checked = true;
        toggleAudioFields();
        
        document.querySelectorAll('#content-add input[id^="cat-"]').forEach(function(cb) {
            cb.checked = story.categories.includes(cb.value);
        });
        
        setCheckboxes('#tropes-grid', story.tropes);
        setCheckboxes('#themes-grid', story.themes);
        setCheckboxes('#warnings-grid', story.warnings);
        setCheckboxes('#eras-grid', story.eras);
        
        if (story.coverImage) {
            currentCoverImage = story.coverImage;
            document.getElementById('cover-preview').src = 'data:' + story.coverImage.contentType + ';base64,' + story.coverImage.data;
            document.getElementById('cover-preview-container').style.display = 'block';
            document.getElementById('upload-section').style.display = 'none';
        }
        
        closeModal();
        switchTab('add');
        showMessage('Editing story - make changes and save');
    }

    function setCheckboxes(containerSelector, values) {
        document.querySelectorAll(containerSelector + ' input[type="checkbox"]').forEach(function(cb) {
            cb.checked = values.includes(cb.value);
        });
    }

    function deleteStory(storyId) {
        var story = stories.find(function(s) { return s.id === storyId; });
        if (!story) return;
        
        if (confirm('Delete "' + story.title + '"? This cannot be undone.')) {
            stories = stories.filter(function(s) { return s.id !== storyId; });
            localStorage.setItem('fanfiction_stories', JSON.stringify(stories));
            displayStories();
            closeModal();
            showMessage('Story deleted');
        }
    }

    function closeModal() {
        document.getElementById('story-modal').classList.remove('active');
    }

    function generateAnalytics() {
        var container = document.getElementById('stats-container');
        
        if (stories.length === 0) {
            container.innerHTML = '<div class="form-section"><p style="text-align: center; color: #6b7280;">No stories to analyze yet.</p></div>';
            return;
        }
        
        var totalWords = stories.reduce(function(sum, s) { return sum + (s.wordCount || 0); }, 0);
        var avgWords = stories.filter(function(s) { return s.wordCount; }).length;
        avgWords = avgWords > 0 ? Math.round(totalWords / avgWords) : 0;
        
        var categoryCounts = {};
        var platformCounts = {};
        var tropeCounts = {};
        
        stories.forEach(function(story) {
            story.categories.forEach(function(cat) {
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });
            
            if (story.platform) {
                platformCounts[story.platform] = (platformCounts[story.platform] || 0) + 1;
            }
            
            story.tropes.forEach(function(trope) {
                tropeCounts[trope] = (tropeCounts[trope] || 0) + 1;
            });
        });
        
        var topTropes = Object.entries(tropeCounts)
            .sort(function(a, b) { return b[1] - a[1]; })
            .slice(0, 10);
        
        var html = '<div class="form-section">' +
            '<h3>Overview</h3>' +
            '<p><strong>Total Stories:</strong> ' + stories.length + '</p>' +
            '<p><strong>Total Words:</strong> ' + totalWords.toLocaleString() + '</p>' +
            '<p><strong>Average Words:</strong> ' + avgWords.toLocaleString() + '</p>' +
            '</div>';
        
        html += '<div class="form-section"><h3><i class="fas fa-chart-pie"></i> By Category</h3>';
        Object.entries(categoryCounts).forEach(function(entry) {
            var pct = ((entry[1] / stories.length) * 100).toFixed(1);
            html += '<p>' + entry[0].toUpperCase() + ': ' + entry[1] + ' (' + pct + '%)</p>';
        });
        html += '</div>';
        
        if (Object.keys(platformCounts).length > 0) {
            html += '<div class="form-section"><h3><i class="fas fa-globe"></i> By Platform</h3>';
            Object.entries(platformCounts).forEach(function(entry) {
                var pct = ((entry[1] / stories.length) * 100).toFixed(1);
                html += '<p>' + entry[0] + ': ' + entry[1] + ' (' + pct + '%)</p>';
            });
            html += '</div>';
        }
        
        if (topTropes.length > 0) {
            html += '<div class="form-section"><h3><i class="fas fa-heart"></i> Top 10 Tropes</h3>';
            topTropes.forEach(function(entry) {
                var pct = ((entry[1] / stories.length) * 100).toFixed(1);
                html += '<p>' + entry[0] + ': ' + entry[1] + ' (' + pct + '%)</p>';
            });
            html += '</div>';
        }
        
        container.innerHTML = html;
    }

    function scrapeFromURL() {
        var url = document.getElementById('story-url').value.trim();
        if (!url) {
            showMessage('Please enter a URL', 'error');
            return;
        }

        try {
            var urlObj = new URL(url);
            
            if (urlObj.hostname.includes('archiveofourown.org')) {
                document.getElementById('platform').value = 'AO3';
                showMessage('Platform set to AO3. Please fill in other details manually.');
            } else if (urlObj.hostname.includes('fanfiction.net')) {
                document.getElementById('platform').value = 'FanFiction.Net';
                showMessage('Platform set to FanFiction.Net. Please fill in other details manually.');
            } else if (urlObj.hostname.includes('wattpad.com')) {
                document.getElementById('platform').value = 'Wattpad';
                showMessage('Platform set to Wattpad. Please fill in other details manually.');
            } else {
                showMessage('Platform detected. Please fill in story details manually.');
            }
        } catch (e) {
            showMessage('Invalid URL format', 'error');
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function loadStories() {
        var stored = localStorage.getItem('fanfiction_stories');
        if (stored) {
            try {
                stories = JSON.parse(stored);
                displayStories();
            } catch (e) {
                console.error('Error loading stories:', e);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(function() { console.log('Service Worker registered'); })
                .catch(function(err) { console.log('Service Worker registration failed:', err); });
        }
        
        // Show install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            var installDiv = document.createElement('div');
            installDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #4f46e5; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            installDiv.innerHTML = '<i class="fas fa-download"></i> Install App';
            installDiv.onclick = function() {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                    installDiv.remove();
                });
            };
            document.body.appendChild(installDiv);
        });
        
        document.getElementById('tab-library').addEventListener('click', function() { switchTab('library'); });
        document.getElementById('tab-add').addEventListener('click', function() { switchTab('add'); });
        document.getElementById('tab-analytics').addEventListener('click', function() { switchTab('analytics'); });
        
        document.getElementById('save-btn').addEventListener('click', saveStory);
        document.getElementById('clear-btn').addEventListener('click', clearForm);
        document.getElementById('analytics-btn').addEventListener('click', generateAnalytics);
        document.getElementById('cover-upload').addEventListener('change', handleCoverUpload);
        document.getElementById('remove-cover').addEventListener('click', removeCover);
        document.getElementById('scrape-btn').addEventListener('click', scrapeFromURL);
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('search-input').addEventListener('input', filterStories);
        document.getElementById('category-filter').addEventListener('change', filterStories);
        
        document.querySelectorAll('input[name="reading-format"]').forEach(function(radio) {
            radio.addEventListener('change', toggleAudioFields);
        });
        
        document.getElementById('story-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        populateCheckboxes();
        loadStories();
    });
</script>
```

</body>
</html>
